# Live555æºç å­¦ä¹ ç¬”è®°â€”â€”BasicTaskSchedulerå®ç°è¯¦è§£

## ä¸€ã€æ¨¡å—æ¦‚è¿°

### 1.1 ç±»ç»§æ‰¿ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TaskScheduler ç±»å±‚æ¬¡ç»“æ„                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   TaskScheduler (æŠ½è±¡æ¥å£)                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ å®šä¹‰æ¥å£ï¼š                                               â”‚   â”‚
â”‚   â”‚ â€¢ scheduleDelayedTask()                                 â”‚   â”‚
â”‚   â”‚ â€¢ setBackgroundHandling()                               â”‚   â”‚
â”‚   â”‚ â€¢ doEventLoop()                                         â”‚   â”‚
â”‚   â”‚ â€¢ createEventTrigger()                                  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                               â”‚ ç»§æ‰¿                            â”‚
â”‚                               â–¼                                 â”‚
â”‚   BasicTaskScheduler0 (åŸºç¡€å®ç°)                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ å®ç°ï¼š                                                   â”‚   â”‚
â”‚   â”‚ â€¢ scheduleDelayedTask() - å»¶æ—¶ä»»åŠ¡                       â”‚   â”‚
â”‚   â”‚ â€¢ doEventLoop() - äº‹ä»¶å¾ªç¯æ¡†æ¶                           â”‚   â”‚
â”‚   â”‚ â€¢ createEventTrigger() - äº‹ä»¶è§¦å‘å™¨                      â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚ æˆå‘˜ï¼š                                                   â”‚   â”‚
â”‚   â”‚ â€¢ fDelayQueue - å»¶æ—¶é˜Ÿåˆ—                                â”‚   â”‚
â”‚   â”‚ â€¢ fHandlers - Socketå¤„ç†å™¨é›†åˆ                          â”‚   â”‚
â”‚   â”‚ â€¢ fTriggeredEventHandlers[] - äº‹ä»¶è§¦å‘å™¨æ•°ç»„            â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                               â”‚ ç»§æ‰¿                            â”‚
â”‚                               â–¼                                 â”‚
â”‚   BasicTaskScheduler (æœ€ç»ˆå®ç°)                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ å®ç°ï¼š                                                   â”‚   â”‚
â”‚   â”‚ â€¢ SingleStep() - å•æ­¥æ‰§è¡Œï¼ˆæ ¸å¿ƒï¼ï¼‰                      â”‚   â”‚
â”‚   â”‚ â€¢ setBackgroundHandling() - Socketå¤„ç†                  â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚ æˆå‘˜ï¼š                                                   â”‚   â”‚
â”‚   â”‚ â€¢ fReadSet, fWriteSet, fExceptionSet - fd_set          â”‚   â”‚
â”‚   â”‚ â€¢ fMaxNumSockets - æœ€å¤§Socketæ•°                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ–‡ä»¶ç»“æ„

```
BasicUsageEnvironment/
â”œâ”€â”€ include/
â”‚   â”œâ”€â”€ BasicUsageEnvironment.hh
â”‚   â”œâ”€â”€ BasicUsageEnvironment0.hh   # å£°æ˜BasicTaskScheduler0
â”‚   â”œâ”€â”€ DelayQueue. hh               # å»¶æ—¶é˜Ÿåˆ—
â”‚   â””â”€â”€ HandlerSet.hh               # Socketå¤„ç†å™¨é›†åˆ
â”œâ”€â”€ BasicTaskScheduler. cpp          # BasicTaskSchedulerå®ç°
â”œâ”€â”€ BasicTaskScheduler0.cpp         # BasicTaskScheduler0å®ç°
â”œâ”€â”€ DelayQueue.cpp                  # å»¶æ—¶é˜Ÿåˆ—å®ç°
â””â”€â”€ BasicUsageEnvironment.cpp
```

---

## äºŒã€æ ¸å¿ƒæ•°æ®ç»“æ„

### 2.1 BasicTaskScheduler0 æˆå‘˜å˜é‡

```cpp
class BasicTaskScheduler0 : public TaskScheduler {
protected:
    // ========== å»¶æ—¶ä»»åŠ¡é˜Ÿåˆ— ==========
    DelayQueue fDelayQueue;  // ç®¡ç†æ‰€æœ‰å®šæ—¶ä»»åŠ¡
    
    // ========== Socketå¤„ç†å™¨ ==========
    HandlerSet* fHandlers;   // ç®¡ç†æ‰€æœ‰Socketå›è°ƒ
    int fLastHandledSocketNum;  // ä¸Šæ¬¡å¤„ç†çš„Socketï¼ˆä¿è¯å…¬å¹³ï¼‰
    
    // ========== äº‹ä»¶è§¦å‘å™¨ ==========
    static const unsigned MAX_NUM_EVENT_TRIGGERS = 32;
    
    TaskFunc* fTriggeredEventHandlers[MAX_NUM_EVENT_TRIGGERS];
    void* fTriggeredEventClientDatas[MAX_NUM_EVENT_TRIGGERS];
    std::atomic_flag fTriggersAwaitingHandling[MAX_NUM_EVENT_TRIGGERS];
    
    Boolean fEventTriggersAreBeingUsed;
    u_int32_t fLastUsedTriggerMask;
    unsigned fLastUsedTriggerNum;
    
    // ========== è¾…åŠ©å˜é‡ ==========
    intptr_t fTokenCounter;  // ä»»åŠ¡Tokenè®¡æ•°å™¨
};
```

### 2.2 BasicTaskScheduler æˆå‘˜å˜é‡

```cpp
class BasicTaskScheduler : public BasicTaskScheduler0 {
private:
    // ========== select() ç›¸å…³ ==========
    fd_set fReadSet;       // ç›‘å¬å¯è¯»çš„Socketé›†åˆ
    fd_set fWriteSet;      // ç›‘å¬å¯å†™çš„Socketé›†åˆ
    fd_set fExceptionSet;  // ç›‘å¬å¼‚å¸¸çš„Socketé›†åˆ
    int fMaxNumSockets;    // æœ€å¤§Socketç¼–å·+1ï¼ˆselectç¬¬ä¸€ä¸ªå‚æ•°ï¼‰
    
    // ========== è°ƒåº¦ç²’åº¦ ==========
    unsigned fMaxSchedulerGranularity;  // æœ€å¤§è°ƒåº¦é—´éš”ï¼ˆå¾®ç§’ï¼‰
    
#if defined(__WIN32__) || defined(_WIN32)
    int fDummySocketNum;   // Windowså¹³å°çš„è™šæ‹ŸSocket
#endif
};
```

### 2.3 æ•°æ®ç»“æ„å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 BasicTaskScheduler æ•°æ®ç»“æ„                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    fDelayQueue                          â”‚   â”‚
â”‚   â”‚                   (å»¶æ—¶ä»»åŠ¡é˜Ÿåˆ—)                          â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚   head â”€â”€â–º [Task1] â”€â”€â–º [Task2] â”€â”€â–º [Task3] â”€â”€â–º ...      â”‚   â”‚
â”‚   â”‚            100ms       300ms       500ms                â”‚   â”‚
â”‚   â”‚           åˆ°æœŸæ—¶é—´æŒ‰å¢é‡å­˜å‚¨                              â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                     fHandlers                           â”‚   â”‚
â”‚   â”‚                (Socketå¤„ç†å™¨é›†åˆ)                         â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚   â”‚
â”‚   â”‚   â”‚Socket 3â”‚â—„â”€â–ºâ”‚Socket 5â”‚â—„â”€â–ºâ”‚Socket 8â”‚â—„â”€â–º ...          â”‚   â”‚
â”‚   â”‚   â”‚handler â”‚   â”‚handler â”‚   â”‚handler â”‚                 â”‚   â”‚
â”‚   â”‚   â”‚  data  â”‚   â”‚  data  â”‚   â”‚  data  â”‚                 â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚   â”‚
â”‚   â”‚              (åŒå‘å¾ªç¯é“¾è¡¨)                               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚              fReadSet / fWriteSet / fExceptionSet       â”‚   â”‚
â”‚   â”‚                      (fd_set ä½å›¾)                       â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚   Socket:  0  1  2  3  4  5  6  7  8  ...               â”‚   â”‚
â”‚   â”‚   Read:    0  0  0  1  0  1  0  0  1  ...              â”‚   â”‚
â”‚   â”‚   Write:   0  0  0  0  0  1  0  0  0  ...               â”‚   â”‚
â”‚   â”‚   Except:  0  0  0  0  0  0  0  0  0  ...               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚            fTriggeredEventHandlers[32]                  â”‚   â”‚
â”‚   â”‚                  (äº‹ä»¶è§¦å‘å™¨æ•°ç»„)                         â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚   [0]: handler0, data0, pending=false                   â”‚   â”‚
â”‚   â”‚   [1]: handler1, data1, pending=true  â—„â”€â”€ å¾…å¤„ç†        â”‚   â”‚
â”‚   â”‚   [2]: NULL (æœªä½¿ç”¨)                                    â”‚   â”‚
â”‚   â”‚   ...                                                    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€æ„é€ å‡½æ•°åˆ†æ

### 3.1 BasicTaskScheduler0 æ„é€ å‡½æ•°

```cpp
// æ–‡ä»¶ï¼šBasicTaskScheduler0. cpp

BasicTaskScheduler0::BasicTaskScheduler0()
  : fTokenCounter(0),                              // Tokenè®¡æ•°å™¨åˆå§‹åŒ–
    fLastHandledSocketNum(-1),                     // æ— ä¸Šæ¬¡å¤„ç†çš„Socket
    fLastUsedTriggerMask(1),                       // è§¦å‘å™¨æ©ç åˆå§‹åŒ–
    fLastUsedTriggerNum(MAX_NUM_EVENT_TRIGGERS-1), // è§¦å‘å™¨ç´¢å¼•åˆå§‹åŒ–
    fEventTriggersAreBeingUsed(False)              // å°šæœªä½¿ç”¨è§¦å‘å™¨
{
    // åˆ›å»ºSocketå¤„ç†å™¨é›†åˆ
    fHandlers = new HandlerSet;
    
    // åˆå§‹åŒ–äº‹ä»¶è§¦å‘å™¨æ•°ç»„
    for (unsigned i = 0; i < MAX_NUM_EVENT_TRIGGERS; ++i) {
#ifndef NO_STD_LIB
        fTriggersAwaitingHandling[i]. clear();  // åŸå­æ ‡å¿—æ¸…é›¶
#else
        fTriggersAwaitingHandling[i] = False;
#endif
        fTriggeredEventHandlers[i] = NULL;     // å¤„ç†å‡½æ•°ç½®ç©º
        fTriggeredEventClientDatas[i] = NULL;  // ç”¨æˆ·æ•°æ®ç½®ç©º
    }
}
```

### 3.2 BasicTaskScheduler æ„é€ å‡½æ•°

```cpp
// æ–‡ä»¶ï¼šBasicTaskScheduler. cpp

BasicTaskScheduler* BasicTaskScheduler::createNew(unsigned maxSchedulerGranularity) {
    return new BasicTaskScheduler(maxSchedulerGranularity);
}

BasicTaskScheduler::BasicTaskScheduler(unsigned maxSchedulerGranularity)
  : fMaxSchedulerGranularity(maxSchedulerGranularity),
    fMaxNumSockets(0)
#if defined(__WIN32__) || defined(_WIN32)
  , fDummySocketNum(-1)
#endif
{
    // æ¸…ç©ºä¸‰ä¸ªfd_set
    FD_ZERO(&fReadSet);
    FD_ZERO(&fWriteSet);
    FD_ZERO(&fExceptionSet);

    // å¦‚æœè®¾ç½®äº†è°ƒåº¦ç²’åº¦ï¼Œå¯åŠ¨å®šæ—¶tickä»»åŠ¡
    if (maxSchedulerGranularity > 0) {
        schedulerTickTask();  // ç¡®ä¿å®šæœŸå¤„ç†äº‹ä»¶
    }
}

// è°ƒåº¦å™¨tickä»»åŠ¡ - ä¿è¯äº‹ä»¶å¾ªç¯çš„æœ€å°å“åº”é—´éš”
void BasicTaskScheduler::schedulerTickTask(void* clientData) {
    ((BasicTaskScheduler*)clientData)->schedulerTickTask();
}

void BasicTaskScheduler::schedulerTickTask() {
    // é‡æ–°è°ƒåº¦è‡ªå·±ï¼Œå½¢æˆå‘¨æœŸæ€§ä»»åŠ¡
    scheduleDelayedTask(fMaxSchedulerGranularity, schedulerTickTask, this);
}
```

**è°ƒåº¦ç²’åº¦çš„ä½œç”¨ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    maxSchedulerGranularity ä½œç”¨                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   é—®é¢˜ï¼šå¦‚æœæ²¡æœ‰Socketäº‹ä»¶ï¼Œä¹Ÿæ²¡æœ‰å®šæ—¶ä»»åŠ¡ï¼Œselect()ä¼šä¸€ç›´é˜»å¡     â”‚
â”‚                                                                 â”‚
â”‚   è§£å†³ï¼šè®¾ç½®maxSchedulerGranularityåï¼Œä¼šå‘¨æœŸæ€§è°ƒåº¦ä¸€ä¸ªtickä»»åŠ¡   â”‚
â”‚         ä¿è¯select()çš„è¶…æ—¶æ—¶é—´ä¸ä¼šè¶…è¿‡è¿™ä¸ªå€¼                     â”‚
â”‚                                                                 â”‚
â”‚   ä¾‹å¦‚ï¼šmaxSchedulerGranularity = 10000 (10ms)                  â”‚
â”‚         åˆ™äº‹ä»¶å¾ªç¯è‡³å°‘æ¯10msä¼šæ‰§è¡Œä¸€æ¬¡                           â”‚
â”‚                                                                 â”‚
â”‚   åº”ç”¨åœºæ™¯ï¼š                                                     â”‚
â”‚   - éœ€è¦å¿«é€Ÿå“åº”çš„åº”ç”¨                                           â”‚
â”‚   - éœ€è¦å®šæœŸæ£€æŸ¥æŸäº›çŠ¶æ€                                         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€äº‹ä»¶å¾ªç¯æ ¸å¿ƒå®ç°

### 4.1 doEventLoop() - äº‹ä»¶å¾ªç¯å…¥å£

```cpp
// æ–‡ä»¶ï¼šBasicTaskScheduler0.cpp

void BasicTaskScheduler0::doEventLoop(EventLoopWatchVariable* watchVariable) {
    // Repeatedly loop, handling readable sockets and timed events:
    while (1) {
        // æ£€æŸ¥é€€å‡ºæ¡ä»¶
        if (watchVariable != NULL && *watchVariable != 0) break;
        
        // æ‰§è¡Œä¸€æ¬¡äº‹ä»¶å¤„ç†
        SingleStep();
    }
}
```

**æµç¨‹å›¾ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    doEventLoop() æµç¨‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                        â”‚    å¼€å§‹      â”‚                         â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                               â”‚                                 â”‚
â”‚                               â–¼                                 â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚              â”‚  watchVariable != 0 ?           â”‚                 â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                    Yes â”‚             â”‚ No                       â”‚
â”‚                        â”‚             â”‚                          â”‚
â”‚                        â–¼             â–¼                          â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚               â”‚   é€€å‡º     â”‚  â”‚ SingleStep() â”‚                  â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                      â”‚                          â”‚
â”‚                                      â”‚                          â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                               (å¾ªç¯)                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 SingleStep() - å•æ­¥æ‰§è¡Œï¼ˆæœ€æ ¸å¿ƒï¼ï¼‰

è¿™æ˜¯æ•´ä¸ªäº‹ä»¶å¾ªç¯çš„æ ¸å¿ƒï¼Œæ¥ä¸‹æ¥é€æ®µè¯¦ç»†åˆ†æï¼š

#### 4.2.1 ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡select()å‚æ•°

```cpp
// æ–‡ä»¶ï¼šBasicTaskScheduler. cpp

void BasicTaskScheduler::SingleStep(unsigned maxDelayTime) {
    // ========== ç¬¬1æ­¥ï¼šå¤åˆ¶fd_set ==========
    // å¿…é¡»å¤åˆ¶ï¼Œå› ä¸ºselect()ä¼šä¿®æ”¹è¿™äº›é›†åˆ
    fd_set readSet = fReadSet;
    fd_set writeSet = fWriteSet;
    fd_set exceptionSet = fExceptionSet;

    // ========== ç¬¬2æ­¥ï¼šè®¡ç®—è¶…æ—¶æ—¶é—´ ==========
    // ä»å»¶æ—¶é˜Ÿåˆ—è·å–ä¸‹ä¸€ä¸ªä»»åŠ¡çš„åˆ°æœŸæ—¶é—´
    DelayInterval const& timeToDelay = fDelayQueue.timeToNextAlarm();
    struct timeval tv_timeToDelay;
    tv_timeToDelay.tv_sec = timeToDelay.seconds();
    tv_timeToDelay.tv_usec = timeToDelay.useconds();
    
    // é™åˆ¶æœ€å¤§è¶…æ—¶æ—¶é—´ï¼ˆé˜²æ­¢selectå¤±è´¥ï¼‰
    const long MAX_TV_SEC = MILLION;  // çº¦11.5å¤©
    if (tv_timeToDelay.tv_sec > MAX_TV_SEC) {
        tv_timeToDelay.tv_sec = MAX_TV_SEC;
    }
    
    // æ£€æŸ¥maxDelayTimeå‚æ•°é™åˆ¶
    if (maxDelayTime > 0 &&
        (tv_timeToDelay.tv_sec > (long)maxDelayTime/MILLION ||
         (tv_timeToDelay.tv_sec == (long)maxDelayTime/MILLION &&
          tv_timeToDelay.tv_usec > (long)maxDelayTime%MILLION))) {
        tv_timeToDelay.tv_sec = maxDelayTime/MILLION;
        tv_timeToDelay. tv_usec = maxDelayTime%MILLION;
    }
```

**select() è¶…æ—¶æ—¶é—´çš„è®¡ç®—ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   select() è¶…æ—¶æ—¶é—´è®¡ç®—                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   timeout = min(ä¸‹ä¸€ä¸ªå®šæ—¶ä»»åŠ¡åˆ°æœŸæ—¶é—´,                          â”‚
â”‚                 maxDelayTimeå‚æ•°,                                â”‚
â”‚                 MAX_TV_SECé™åˆ¶)                                  â”‚
â”‚                                                                 â”‚
â”‚   ç¤ºä¾‹ï¼š                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ å»¶æ—¶é˜Ÿåˆ—ï¼š[ä»»åŠ¡A: 500ms] -> [ä»»åŠ¡B: 1000ms] -> ...         â”‚ â”‚
â”‚   â”‚                                                           â”‚ â”‚
â”‚   â”‚ timeToNextAlarm() è¿”å› 500ms                              â”‚ â”‚
â”‚   â”‚                                                           â”‚ â”‚
â”‚   â”‚ select() å°†ç­‰å¾…æœ€å¤š 500msï¼š                               â”‚ â”‚
â”‚   â”‚ - å¦‚æœ500mså†…æœ‰Socketäº‹ä»¶ï¼Œæå‰è¿”å›                       â”‚ â”‚
â”‚   â”‚ - å¦‚æœ500msåˆ°æœŸï¼Œè¿”å›å¤„ç†å®šæ—¶ä»»åŠ¡                         â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚   ğŸ’¡ è¿™ä¸ªè®¾è®¡éå¸¸å·§å¦™ï¼š                                          â”‚
â”‚      æ—¢èƒ½åŠæ—¶å“åº”Socketäº‹ä»¶ï¼Œåˆä¸ä¼šé”™è¿‡å®šæ—¶ä»»åŠ¡ï¼                â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2.2 ç¬¬äºŒæ­¥ï¼šè°ƒç”¨select()

```cpp
    // ========== ç¬¬3æ­¥ï¼šè°ƒç”¨select() ==========
    int selectResult = select(fMaxNumSockets, 
                              &readSet, 
                              &writeSet, 
                              &exceptionSet, 
                              &tv_timeToDelay);
    
    // é”™è¯¯å¤„ç†
    if (selectResult < 0) {
#if defined(__WIN32__) || defined(_WIN32)
        int err = WSAGetLastError();
        // Windowsç‰¹æ®Šå¤„ç†ï¼šç©ºreadSetæ—¶å¯èƒ½è¿”å›WSAEINVAL
        if (err == WSAEINVAL && readSet.fd_count == 0) {
            err = EINTR;
            // åˆ›å»ºè™šæ‹ŸSocketé¿å…æ­¤é—®é¢˜
            if (fDummySocketNum >= 0) closeSocket(fDummySocketNum);
            fDummySocketNum = socket(AF_INET, SOCK_DGRAM, 0);
            FD_SET((unsigned)fDummySocketNum, &fReadSet);
        }
        if (err != EINTR) {
#else
        if (errno != EINTR && errno != EAGAIN) {
#endif
            // ä¸¥é‡é”™è¯¯ï¼Œæ‰“å°è°ƒè¯•ä¿¡æ¯
            perror("BasicTaskScheduler::SingleStep(): select() fails");
            fprintf(stderr, "socket numbers used in the select() call:");
            for (int i = 0; i < 10000; ++i) {
                if (FD_ISSET(i, &fReadSet) || FD_ISSET(i, &fWriteSet) || 
                    FD_ISSET(i, &fExceptionSet)) {
                    fprintf(stderr, " %d(", i);
                    if (FD_ISSET(i, &fReadSet)) fprintf(stderr, "r");
                    if (FD_ISSET(i, &fWriteSet)) fprintf(stderr, "w");
                    if (FD_ISSET(i, &fExceptionSet)) fprintf(stderr, "e");
                    fprintf(stderr, ")");
                }
            }
            fprintf(stderr, "\n");
            internalError();
        }
    }
```

**select() ç³»ç»Ÿè°ƒç”¨è¯¦è§£ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      select() ç³»ç»Ÿè°ƒç”¨                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   int select(int nfds,            // æœ€å¤§fd+1                   â”‚
â”‚              fd_set *readfds,     // ç›‘å¬å¯è¯»çš„fdé›†åˆ            â”‚
â”‚              fd_set *writefds,    // ç›‘å¬å¯å†™çš„fdé›†åˆ            â”‚
â”‚              fd_set *exceptfds,   // ç›‘å¬å¼‚å¸¸çš„fdé›†åˆ            â”‚
â”‚              struct timeval *timeout);  // è¶…æ—¶æ—¶é—´             â”‚
â”‚                                                                 â”‚
â”‚   è¿”å›å€¼ï¼š                                                       â”‚
â”‚   - > 0ï¼šå°±ç»ªçš„fdæ•°é‡                                           â”‚
â”‚   - = 0ï¼šè¶…æ—¶ï¼Œæ²¡æœ‰fdå°±ç»ª                                        â”‚
â”‚   - < 0ï¼šå‡ºé”™ï¼ˆæ£€æŸ¥errnoï¼‰                                       â”‚
â”‚                                                                 â”‚
â”‚   å·¥ä½œåŸç†ï¼š                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚   è°ƒç”¨å‰ï¼šreadfds = {3, 5, 8}  è¦ç›‘å¬çš„Socket           â”‚   â”‚
â”‚   â”‚                      â”‚                                  â”‚   â”‚
â”‚   â”‚                      â–¼                                  â”‚   â”‚
â”‚   â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚   â”‚
â”‚   â”‚              â”‚   select()   â”‚  é˜»å¡ç­‰å¾…...               â”‚   â”‚
â”‚   â”‚              â”‚              â”‚                           â”‚   â”‚
â”‚   â”‚              â”‚  Socket 5    â”‚  Socket 5 æœ‰æ•°æ®åˆ°è¾¾ï¼    â”‚   â”‚
â”‚   â”‚              â”‚  å¯è¯»ï¼      â”‚                           â”‚   â”‚
â”‚   â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚   â”‚
â”‚   â”‚                      â”‚                                  â”‚   â”‚
â”‚   â”‚                      â–¼                                  â”‚   â”‚
â”‚   â”‚   è°ƒç”¨åï¼šreadfds = {5}  åªä¿ç•™å°±ç»ªçš„Socket             â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚   âš ï¸ é‡è¦ï¼šselect()ä¼šä¿®æ”¹ä¼ å…¥çš„fd_setï¼                         â”‚
â”‚      æ‰€ä»¥æ¯æ¬¡è°ƒç”¨å‰å¿…é¡»é‡æ–°è®¾ç½®æˆ–å¤åˆ¶                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2.3 ç¬¬ä¸‰æ­¥ï¼šå¤„ç†å°±ç»ªçš„Socket

```cpp
    // ========== ç¬¬4æ­¥ï¼šå¤„ç†Socketäº‹ä»¶ ==========
    HandlerIterator iter(*fHandlers);
    HandlerDescriptor* handler;
    
    // ä»ä¸Šæ¬¡å¤„ç†çš„Socketä¹‹åå¼€å§‹ï¼ˆä¿è¯å…¬å¹³è°ƒåº¦ï¼‰
    if (fLastHandledSocketNum >= 0) {
        while ((handler = iter.next()) != NULL) {
            if (handler->socketNum == fLastHandledSocketNum) break;
        }
        if (handler == NULL) {
            fLastHandledSocketNum = -1;
            iter.reset();  // æ²¡æ‰¾åˆ°ï¼Œä»å¤´å¼€å§‹
        }
    }
    
    // éå†æ‰¾åˆ°ä¸€ä¸ªå°±ç»ªçš„Socket
    while ((handler = iter.next()) != NULL) {
        int sock = handler->socketNum;
        int resultConditionSet = 0;
        
        // æ£€æŸ¥è¿™ä¸ªSocketçš„å°±ç»ªçŠ¶æ€
        if (FD_ISSET(sock, &readSet) && FD_ISSET(sock, &fReadSet))
            resultConditionSet |= SOCKET_READABLE;
        if (FD_ISSET(sock, &writeSet) && FD_ISSET(sock, &fWriteSet))
            resultConditionSet |= SOCKET_WRITABLE;
        if (FD_ISSET(sock, &exceptionSet) && FD_ISSET(sock, &fExceptionSet))
            resultConditionSet |= SOCKET_EXCEPTION;
        
        // å¦‚æœæ»¡è¶³ç›‘å¬æ¡ä»¶ï¼Œè°ƒç”¨å›è°ƒ
        if ((resultConditionSet & handler->conditionSet) != 0 && 
            handler->handlerProc != NULL) {
            fLastHandledSocketNum = sock;
            // è°ƒç”¨å›è°ƒå‡½æ•°ï¼
            (*handler->handlerProc)(handler->clientData, resultConditionSet);
            break;  // æ¯æ¬¡åªå¤„ç†ä¸€ä¸ªSocket
        }
    }
    
    // å¦‚æœæ²¡å¤„ç†å®Œæ‰€æœ‰Socketï¼Œä»å¤´å†æ‰¾ä¸€é
    if (handler == NULL && fLastHandledSocketNum >= 0) {
        iter.reset();
        while ((handler = iter.next()) != NULL) {
            // ...  åŒä¸Šçš„æ£€æŸ¥é€»è¾‘ ...
        }
        if (handler == NULL) fLastHandledSocketNum = -1;
    }
```

**å…¬å¹³è°ƒåº¦æœºåˆ¶ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å…¬å¹³è°ƒåº¦æœºåˆ¶                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   é—®é¢˜ï¼šå¦‚æœæ€»æ˜¯ä»Socketåˆ—è¡¨å¤´éƒ¨å¼€å§‹éå†                         â”‚
â”‚         å‰é¢çš„Socketä¼šè¢«ä¼˜å…ˆå¤„ç†ï¼Œåé¢çš„å¯èƒ½"é¥¥é¥¿"               â”‚
â”‚                                                                 â”‚
â”‚   è§£å†³ï¼šè®°å½•ä¸Šæ¬¡å¤„ç†çš„Socketï¼Œä¸‹æ¬¡ä»å®ƒä¹‹åå¼€å§‹                   â”‚
â”‚                                                                 â”‚
â”‚   ç¤ºä¾‹ï¼š                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Socketåˆ—è¡¨ï¼š[3] -> [5] -> [8] -> [10]                   â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚ ç¬¬1æ¬¡ï¼šä»å¤´å¼€å§‹ï¼Œå¤„ç†Socket 3ï¼Œè®°å½•fLastHandledSocketNum=3â”‚   â”‚
â”‚   â”‚ ç¬¬2æ¬¡ï¼šä»3ä¹‹åå¼€å§‹ï¼Œå¤„ç†Socket 5ï¼Œè®°å½•=5                 â”‚   â”‚
â”‚   â”‚ ç¬¬3æ¬¡ï¼šä»5ä¹‹åå¼€å§‹ï¼Œå¤„ç†Socket 8ï¼Œè®°å½•=8                 â”‚   â”‚
â”‚   â”‚ ç¬¬4æ¬¡ï¼šä»8ä¹‹åå¼€å§‹ï¼Œå¤„ç†Socket 10ï¼Œè®°å½•=10               â”‚   â”‚
â”‚   â”‚ ç¬¬5æ¬¡ï¼šä»10ä¹‹åå¼€å§‹ï¼ˆåˆ°æœ«å°¾ï¼‰ï¼Œä»å¤´å¼€å§‹ï¼Œå¤„ç†Socket 3    â”‚   â”‚
â”‚   â”‚ ...                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚   ğŸ’¡ æ¯æ¬¡åªå¤„ç†ä¸€ä¸ªSocketï¼Œç„¶åç»§ç»­äº‹ä»¶å¾ªç¯                      â”‚
â”‚      è¿™æ ·ä¿è¯äº†æ‰€æœ‰Socketéƒ½æœ‰æœºä¼šè¢«å¤„ç†                         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2.4 ç¬¬å››æ­¥ï¼šå¤„ç†äº‹ä»¶è§¦å‘å™¨

```cpp
    // ========== ç¬¬5æ­¥ï¼šå¤„ç†äº‹ä»¶è§¦å‘å™¨ ==========
    if (fEventTriggersAreBeingUsed) {
        unsigned i = fLastUsedTriggerNum;
        EventTriggerId mask = fLastUsedTriggerMask;

        do {
            // å¾ªç¯éå†æ‰€æœ‰è§¦å‘å™¨æ§½ä½
            i = (i+1) % MAX_NUM_EVENT_TRIGGERS;
            mask >>= 1;
            if (mask == 0) mask = EVENT_TRIGGER_ID_HIGH_BIT;

            // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„è§¦å‘äº‹ä»¶
#ifndef NO_STD_LIB
            if (fTriggersAwaitingHandling[i]. test()) {
                fTriggersAwaitingHandling[i].clear();
#else
            if (fTriggersAwaitingHandling[i]) {
                fTriggersAwaitingHandling[i] = False;
#endif
                // è°ƒç”¨äº‹ä»¶å¤„ç†å‡½æ•°
                if (fTriggeredEventHandlers[i] != NULL) {
                    (*fTriggeredEventHandlers[i])(fTriggeredEventClientDatas[i]);
                }

                fLastUsedTriggerMask = mask;
                fLastUsedTriggerNum = i;
                break;  // æ¯æ¬¡åªå¤„ç†ä¸€ä¸ªè§¦å‘å™¨
            }
        } while (i != fLastUsedTriggerNum);
    }
```

**äº‹ä»¶è§¦å‘å™¨æœºåˆ¶ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     äº‹ä»¶è§¦å‘å™¨æœºåˆ¶                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ç”¨é€”ï¼šå…è®¸ä»å¤–éƒ¨çº¿ç¨‹å®‰å…¨åœ°è§¦å‘äº‹ä»¶                             â”‚
â”‚                                                                 â”‚
â”‚   å·¥ä½œæµç¨‹ï¼š                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚   å¤–éƒ¨çº¿ç¨‹                        ä¸»çº¿ç¨‹ï¼ˆäº‹ä»¶å¾ªç¯ï¼‰     â”‚   â”‚
â”‚   â”‚      â”‚                                 â”‚                â”‚   â”‚
â”‚   â”‚      â”‚ triggerEvent(id, data)          â”‚                â”‚   â”‚
â”‚   â”‚      â”‚         â”‚                       â”‚                â”‚   â”‚
â”‚   â”‚      â”‚         â–¼                       â”‚                â”‚   â”‚
â”‚   â”‚      â”‚  è®¾ç½® fTriggersAwaitingHandling[i] = true        â”‚   â”‚
â”‚   â”‚      â”‚  è®¾ç½® fTriggeredEventClientDatas[i] = data       â”‚   â”‚
â”‚   â”‚      â”‚                                 â”‚                â”‚   â”‚
â”‚   â”‚      â”‚                                 â–¼                â”‚   â”‚
â”‚   â”‚      â”‚                     SingleStep() æ£€æµ‹åˆ°          â”‚   â”‚
â”‚   â”‚      â”‚                     fTriggersAwaitingHandling[i] â”‚   â”‚
â”‚   â”‚      â”‚                                 â”‚                â”‚   â”‚
â”‚   â”‚      â”‚                                 â–¼                â”‚   â”‚
â”‚   â”‚      â”‚                     è°ƒç”¨ handler(data)           â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚   âš ï¸ è¿™æ˜¯Live555ä¸­å”¯ä¸€å¯ä»¥ä»å…¶ä»–çº¿ç¨‹è°ƒç”¨çš„å‡½æ•°ï¼                â”‚
â”‚      ä½¿ç”¨ std::atomic_flag ä¿è¯çº¿ç¨‹å®‰å…¨                         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2.5 ç¬¬äº”æ­¥ï¼šå¤„ç†å»¶æ—¶ä»»åŠ¡

```cpp
    // ========== ç¬¬6æ­¥ï¼šå¤„ç†åˆ°æœŸçš„å»¶æ—¶ä»»åŠ¡ ==========
    fDelayQueue.handleAlarm();
}
```

---

## äº”ã€å»¶æ—¶ä»»åŠ¡è°ƒåº¦å®ç°

### 5.1 scheduleDelayedTask()

```cpp
// æ–‡ä»¶ï¼šBasicTaskScheduler0.cpp

TaskToken BasicTaskScheduler0::scheduleDelayedTask(int64_t microseconds,
                                                   TaskFunc* proc,
                                                   void* clientData) {
    // è´Ÿæ•°å»¶æ—¶è§†ä¸º0ï¼ˆç«‹å³æ‰§è¡Œï¼‰
    if (microseconds < 0) microseconds = 0;
    
    // å°†å¾®ç§’è½¬æ¢ä¸ºDelayInterval
    DelayInterval timeToDelay((long)(microseconds/1000000),   // ç§’
                              (long)(microseconds%1000000));  // å¾®ç§’
    
    // åˆ›å»ºAlarmHandlerï¼ˆå»¶æ—¶ä»»åŠ¡åŒ…è£…å™¨ï¼‰
    AlarmHandler* alarmHandler = new AlarmHandler(proc, 
                                                  clientData, 
                                                  timeToDelay, 
                                                  ++fTokenCounter);
    
    // æ·»åŠ åˆ°å»¶æ—¶é˜Ÿåˆ—
    fDelayQueue.addEntry(alarmHandler);

    // è¿”å›ä»»åŠ¡Token
    return (void*)(alarmHandler->token());
}
```

### 5.2 AlarmHandlerç±»

```cpp
// æ–‡ä»¶ï¼šBasicTaskScheduler0.cpp

// AlarmHandler æ˜¯å»¶æ—¶ä»»åŠ¡çš„åŒ…è£…å™¨
class AlarmHandler: public DelayQueueEntry {
public:
    AlarmHandler(TaskFunc* proc, void* clientData, 
                 DelayInterval timeToDelay, intptr_t token)
        : DelayQueueEntry(timeToDelay, token),
          fProc(proc), 
          fClientData(clientData) {
    }

private:
    // å½“å®šæ—¶å™¨åˆ°æœŸæ—¶ï¼ŒDelayQueueä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•
    virtual void handleTimeout() {
        (*fProc)(fClientData);              // æ‰§è¡Œç”¨æˆ·çš„å›è°ƒ
        DelayQueueEntry::handleTimeout();   // è°ƒç”¨åŸºç±»ï¼ˆåˆ é™¤è‡ªå·±ï¼‰
    }

private:
    TaskFunc* fProc;       // ç”¨æˆ·å›è°ƒå‡½æ•°
    void* fClientData;     // ç”¨æˆ·æ•°æ®
};
```

### 5.3 unscheduleDelayedTask()

```cpp
void BasicTaskScheduler0::unscheduleDelayedTask(TaskToken& prevTask) {
    // ä»é˜Ÿåˆ—ä¸­ç§»é™¤ä»»åŠ¡
    DelayQueueEntry* alarmHandler = fDelayQueue.removeEntry((intptr_t)prevTask);
    
    // å°†Tokenç½®ç©ºï¼ˆé˜²æ­¢é‡å¤å–æ¶ˆï¼‰
    prevTask = NULL;
    
    // åˆ é™¤AlarmHandlerå¯¹è±¡
    delete alarmHandler;
}
```

---

## å…­ã€Socketåå°å¤„ç†å®ç°

### 6.1 setBackgroundHandling()

```cpp
// æ–‡ä»¶ï¼šBasicTaskScheduler. cpp

void BasicTaskScheduler::setBackgroundHandling(int socketNum, 
                                               int conditionSet,
                                               BackgroundHandlerProc* handlerProc, 
                                               void* clientData) {
    // å‚æ•°æ£€æŸ¥
    if (socketNum < 0) return;
#if ! defined(__WIN32__) && !defined(_WIN32) && defined(FD_SETSIZE)
    if (socketNum >= (int)(FD_SETSIZE)) return;  // è¶…å‡ºfd_setèŒƒå›´
#endif

    // å…ˆä»æ‰€æœ‰é›†åˆä¸­æ¸…é™¤è¿™ä¸ªSocket
    FD_CLR((unsigned)socketNum, &fReadSet);
    FD_CLR((unsigned)socketNum, &fWriteSet);
    FD_CLR((unsigned)socketNum, &fExceptionSet);
    
    if (conditionSet == 0) {
        // conditionSetä¸º0è¡¨ç¤ºå–æ¶ˆç›‘å¬
        fHandlers->clearHandler(socketNum);
        
        // æ›´æ–°æœ€å¤§Socketç¼–å·
        if (socketNum+1 == fMaxNumSockets) {
            --fMaxNumSockets;
        }
    } else {
        // æ³¨å†Œæ–°çš„å¤„ç†å™¨
        fHandlers->assignHandler(socketNum, conditionSet, handlerProc, clientData);
        
        // æ›´æ–°æœ€å¤§Socketç¼–å·
        if (socketNum+1 > fMaxNumSockets) {
            fMaxNumSockets = socketNum+1;
        }
        
        // æ ¹æ®æ¡ä»¶è®¾ç½®å¯¹åº”çš„fd_set
        if (conditionSet & SOCKET_READABLE)
            FD_SET((unsigned)socketNum, &fReadSet);
        if (conditionSet & SOCKET_WRITABLE)
            FD_SET((unsigned)socketNum, &fWriteSet);
        if (conditionSet & SOCKET_EXCEPTION)
            FD_SET((unsigned)socketNum, &fExceptionSet);
    }
}
```

### 6.2 ä½¿ç”¨ç¤ºä¾‹

```cpp
// ç›‘å¬Socketå¯è¯»ï¼ˆæ¥æ”¶æ•°æ®ï¼‰
env->taskScheduler().setBackgroundHandling(
    sockfd,
    SOCKET_READABLE,
    onDataReceived,
    this
);

// ç›‘å¬Socketå¯è¯»å’Œå¯å†™
env->taskScheduler().setBackgroundHandling(
    sockfd,
    SOCKET_READABLE | SOCKET_WRITABLE,
    onSocketReady,
    this
);

// å–æ¶ˆç›‘å¬
env->taskScheduler().setBackgroundHandling(sockfd, 0, NULL, NULL);
// æˆ–è€…ä½¿ç”¨ä¾¿æ·æ–¹æ³•
env->taskScheduler().disableBackgroundHandling(sockfd);
```

---

## ä¸ƒã€äº‹ä»¶è§¦å‘å™¨å®ç°

### 7.1 createEventTrigger()

```cpp
// æ–‡ä»¶ï¼šBasicTaskScheduler0.cpp

EventTriggerId BasicTaskScheduler0::createEventTrigger(TaskFunc* eventHandlerProc) {
    unsigned i = fLastUsedTriggerNum;
    u_int32_t mask = fLastUsedTriggerMask;

    do {
        // å¾ªç¯æŸ¥æ‰¾ç©ºé—²çš„è§¦å‘å™¨æ§½ä½
        i = (i+1) % MAX_NUM_EVENT_TRIGGERS;
        mask >>= 1;
        if (mask == 0) mask = EVENT_TRIGGER_ID_HIGH_BIT;

        if (fTriggeredEventHandlers[i] == NULL) {
            // æ‰¾åˆ°ç©ºé—²æ§½ä½ï¼Œæ³¨å†Œå¤„ç†å‡½æ•°
            fTriggeredEventHandlers[i] = eventHandlerProc;
            fTriggeredEventClientDatas[i] = NULL;

            fLastUsedTriggerMask = mask;
            fLastUsedTriggerNum = i;
            fEventTriggersAreBeingUsed = True;

            return mask;  // è¿”å›è§¦å‘å™¨IDï¼ˆä½æ©ç ï¼‰
        }
    } while (i != fLastUsedTriggerNum);

    // æ‰€æœ‰æ§½ä½éƒ½å·²ä½¿ç”¨
    return 0;
}
```

### 7.2 triggerEvent()ï¼ˆå¯ä»å¤–éƒ¨çº¿ç¨‹è°ƒç”¨ï¼‰

```cpp
void BasicTaskScheduler0::triggerEvent(EventTriggerId eventTriggerId, 
                                       void* clientData) {
    EventTriggerId mask = EVENT_TRIGGER_ID_HIGH_BIT;
    
    for (unsigned i = 0; i < MAX_NUM_EVENT_TRIGGERS; ++i) {
        if ((eventTriggerId & mask) != 0) {
            // è®¾ç½®å®¢æˆ·ç«¯æ•°æ®
            fTriggeredEventClientDatas[i] = clientData;
            
            // åŸå­åœ°è®¾ç½®å¾…å¤„ç†æ ‡å¿—ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
#ifndef NO_STD_LIB
            (void)fTriggersAwaitingHandling[i].test_and_set();
#else
            fTriggersAwaitingHandling[i] = True;
#endif
        }
        mask >>= 1;
    }
}
```

### 7.3 deleteEventTrigger()

```cpp
void BasicTaskScheduler0::deleteEventTrigger(EventTriggerId eventTriggerId) {
    EventTriggerId mask = EVENT_TRIGGER_ID_HIGH_BIT;
    Boolean eventTriggersAreBeingUsed = False;

    for (unsigned i = 0; i < MAX_NUM_EVENT_TRIGGERS; ++i) {
        if ((eventTriggerId & mask) != 0) {
            // æ¸…é™¤è¿™ä¸ªè§¦å‘å™¨
#ifndef NO_STD_LIB
            fTriggersAwaitingHandling[i].clear();
#else
            fTriggersAwaitingHandling[i] = False;
#endif
            fTriggeredEventHandlers[i] = NULL;
            fTriggeredEventClientDatas[i] = NULL;
        } else if (fTriggeredEventHandlers[i] != NULL) {
            eventTriggersAreBeingUsed = True;
        }
        mask >>= 1;
    }

    fEventTriggersAreBeingUsed = eventTriggersAreBeingUsed;
}
```

---

## å…«ã€SingleStep() å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SingleStep() å®Œæ•´æµç¨‹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚ 1. å‡†å¤‡é˜¶æ®µ                                                   â”‚     â”‚
â”‚   â”‚    â€¢ å¤åˆ¶ fReadSet, fWriteSet, fExceptionSet                 â”‚     â”‚
â”‚   â”‚    â€¢ è®¡ç®— timeout = min(ä¸‹ä¸€ä¸ªå®šæ—¶ä»»åŠ¡åˆ°æœŸæ—¶é—´, maxDelayTime) â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                    â”‚                                    â”‚
â”‚                                    â–¼                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚ 2. è°ƒç”¨ select()                                              â”‚     â”‚
â”‚   â”‚    â€¢ é˜»å¡ç­‰å¾…Socketäº‹ä»¶æˆ–è¶…æ—¶                                 â”‚     â”‚
â”‚   â”‚    â€¢ è¿”å›å°±ç»ªçš„Socketæ•°é‡                                     â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                    â”‚                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚              â–¼                     â–¼                     â–¼              â”‚
â”‚         selectResult > 0     selectResult = 0      selectResult < 0    â”‚
â”‚         (æœ‰Socketå°±ç»ª)       (è¶…æ—¶)                (é”™è¯¯)              â”‚
â”‚              â”‚                     â”‚                     â”‚              â”‚
â”‚              â–¼                     â”‚                     â–¼              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚           å¤„ç†é”™è¯¯/å¿½ç•¥EINTR       â”‚
â”‚   â”‚ 3. å¤„ç†Socketäº‹ä»¶    â”‚         â”‚                                    â”‚
â”‚   â”‚    â€¢ éå†HandlerSet  â”‚         â”‚                                    â”‚
â”‚   â”‚    â€¢ æ‰¾åˆ°å°±ç»ªçš„Socketâ”‚         â”‚                                    â”‚
â”‚   â”‚    â€¢ è°ƒç”¨å…¶å›è°ƒå‡½æ•°  â”‚         â”‚                                    â”‚
â”‚   â”‚    â€¢ åªå¤„ç†ä¸€ä¸ªï¼    â”‚         â”‚                                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚                                    â”‚
â”‚              â”‚                     â”‚                                    â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                         â–¼                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚ 4. å¤„ç†äº‹ä»¶è§¦å‘å™¨                                             â”‚     â”‚
â”‚   â”‚    â€¢ æ£€æŸ¥ fTriggersAwaitingHandling[]                        â”‚     â”‚
â”‚   â”‚    â€¢ æ‰¾åˆ°å¾…å¤„ç†çš„è§¦å‘å™¨                                       â”‚     â”‚
â”‚   â”‚    â€¢ è°ƒç”¨å…¶å›è°ƒå‡½æ•°                                           â”‚     â”‚
â”‚   â”‚    â€¢ åªå¤„ç†ä¸€ä¸ªï¼                                             â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                    â”‚                                    â”‚
â”‚                                    â–¼                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚ 5. å¤„ç†å»¶æ—¶ä»»åŠ¡                                               â”‚     â”‚
â”‚   â”‚    â€¢ fDelayQueue.handleAlarm()                               â”‚     â”‚
â”‚   â”‚    â€¢ æ£€æŸ¥é˜Ÿé¦–ä»»åŠ¡æ˜¯å¦åˆ°æœŸ                                     â”‚     â”‚
â”‚   â”‚    â€¢ å¦‚æœåˆ°æœŸï¼Œè°ƒç”¨å…¶ handleTimeout()                        â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                    â”‚                                    â”‚
â”‚                                    â–¼                                    â”‚
â”‚                              è¿”å›ï¼Œç»§ç»­ä¸‹ä¸€è½®å¾ªç¯                        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¹ã€é‡è¦è®¾è®¡æ€æƒ³æ€»ç»“

### 9.1 å•çº¿ç¨‹äº‹ä»¶é©±åŠ¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Live555 å•çº¿ç¨‹ vs å¤šçº¿ç¨‹                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ã€Live555 å•çº¿ç¨‹æ¨¡å‹ã€‘                                          â”‚
â”‚                                                                 â”‚
â”‚   ä¼˜ç‚¹ï¼š                                                        â”‚
â”‚   âœ“ æ— éœ€åŠ é”ï¼Œä»£ç ç®€å•                                          â”‚
â”‚   âœ“ æ— ç«æ€æ¡ä»¶ï¼Œè°ƒè¯•å®¹æ˜“                                        â”‚
â”‚   âœ“ å†…å­˜å ç”¨å°ï¼Œé€‚åˆåµŒå…¥å¼                                      â”‚
â”‚                                                                 â”‚
â”‚   ç¼ºç‚¹ï¼š                                                        â”‚
â”‚   âœ— æ— æ³•åˆ©ç”¨å¤šæ ¸CPU                                             â”‚
â”‚   âœ— å›è°ƒå¿…é¡»å¿«é€Ÿè¿”å›                                            â”‚
â”‚   âœ— ä¸€ä¸ªé˜»å¡ä¼šå½±å“å…¨éƒ¨                                          â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚  ã€ç¼–ç¨‹è§„èŒƒã€‘                                                    â”‚
â”‚                                                                 â”‚
â”‚   1. å›è°ƒå‡½æ•°å¿…é¡»å¿«é€Ÿè¿”å›ï¼ˆ<10msï¼‰                               â”‚
â”‚   2. è€—æ—¶æ“ä½œè¦æ‹†åˆ†æˆå¤šä¸ªå°ä»»åŠ¡                                  â”‚
â”‚   3. ç¦æ­¢åœ¨å›è°ƒä¸­è°ƒç”¨é˜»å¡å‡½æ•°                                    â”‚
â”‚   4. å”¯ä¸€å¯è·¨çº¿ç¨‹è°ƒç”¨çš„æ˜¯ triggerEvent()                        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 æ¯æ¬¡åªå¤„ç†ä¸€ä¸ªäº‹ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  "æ¯æ¬¡åªå¤„ç†ä¸€ä¸ª"åŸåˆ™                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   SingleStep() æ¯æ¬¡è°ƒç”¨ï¼š                                        â”‚
â”‚   â€¢ åªå¤„ç†ä¸€ä¸ªå°±ç»ªçš„Socket                                      â”‚
â”‚   â€¢ åªå¤„ç†ä¸€ä¸ªå¾…è§¦å‘çš„äº‹ä»¶                                      â”‚
â”‚   â€¢ åªå¤„ç†ä¸€ä¸ªåˆ°æœŸçš„å®šæ—¶ä»»åŠ¡ï¼ˆåœ¨handleAlarmä¸­ï¼‰                  â”‚
â”‚                                                                 â”‚
â”‚   ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ                                               â”‚
â”‚                                                                 â”‚
â”‚   1. å…¬å¹³æ€§ï¼šé¿å…æŸç±»äº‹ä»¶ç‹¬å CPU                                 â”‚
â”‚   2. å“åº”æ€§ï¼šä¿è¯å„ç±»äº‹ä»¶éƒ½èƒ½åŠæ—¶å¤„ç†                            â”‚
â”‚   3. ç®€å•æ€§ï¼šä»£ç é€»è¾‘æ¸…æ™°ï¼Œå®¹æ˜“ç†è§£                              â”‚
â”‚                                                                 â”‚
â”‚   æ—¶é—´çº¿ç¤ºä¾‹ï¼š                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ SingleStep #1: å¤„ç†Socket Açš„å¯è¯»äº‹ä»¶                   â”‚   â”‚
â”‚   â”‚ SingleStep #2: å¤„ç†å®šæ—¶ä»»åŠ¡1                            â”‚   â”‚
â”‚   â”‚ SingleStep #3: å¤„ç†äº‹ä»¶è§¦å‘å™¨                           â”‚   â”‚
â”‚   â”‚ SingleStep #4: å¤„ç†Socket Bçš„å¯è¯»äº‹ä»¶                   â”‚   â”‚
â”‚   â”‚ SingleStep #5: å¤„ç†å®šæ—¶ä»»åŠ¡2                            â”‚   â”‚
â”‚   â”‚ ...                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åã€å°ç»“

### 10.1 è¦ç‚¹

1. **BasicTaskScheduler** ç»§æ‰¿è‡ª **BasicTaskScheduler0**ï¼Œåè€…å®ç°äº†å¤§éƒ¨åˆ†åŠŸèƒ½
2. **SingleStep()** æ˜¯äº‹ä»¶å¾ªç¯çš„æ ¸å¿ƒï¼Œä¾æ¬¡å¤„ç†ï¼š
   - Socketäº‹ä»¶ï¼ˆé€šè¿‡selectï¼‰
   - äº‹ä»¶è§¦å‘å™¨
   - å»¶æ—¶ä»»åŠ¡
3. **select()** çš„è¶…æ—¶æ—¶é—´ç”±ä¸‹ä¸€ä¸ªå®šæ—¶ä»»åŠ¡çš„åˆ°æœŸæ—¶é—´å†³å®š
4. **å…¬å¹³è°ƒåº¦**ï¼šè®°å½•ä¸Šæ¬¡å¤„ç†çš„ä½ç½®ï¼Œä¸‹æ¬¡ä»ä¹‹åå¼€å§‹
5. **äº‹ä»¶è§¦å‘å™¨**æ˜¯å”¯ä¸€å¯ä»¥ä»å¤–éƒ¨çº¿ç¨‹è°ƒç”¨çš„æœºåˆ¶

### 10.2 å…³é”®å‡½æ•°é€ŸæŸ¥è¡¨

| å‡½æ•°                      | æ–‡ä»¶                     | åŠŸèƒ½                 |
| ------------------------- | ------------------------ | -------------------- |
| `doEventLoop()`           | BasicTaskScheduler0.cpp  | äº‹ä»¶å¾ªç¯å…¥å£         |
| `SingleStep()`            | BasicTaskScheduler.cpp   | å•æ­¥æ‰§è¡Œï¼ˆæ ¸å¿ƒï¼‰     |
| `scheduleDelayedTask()`   | BasicTaskScheduler0.cpp  | è°ƒåº¦å»¶æ—¶ä»»åŠ¡         |
| `setBackgroundHandling()` | BasicTaskScheduler.cpp   | æ³¨å†ŒSocketå¤„ç†       |
| `createEventTrigger()`    | BasicTaskScheduler0.cpp  | åˆ›å»ºäº‹ä»¶è§¦å‘å™¨       |
| `triggerEvent()`          | BasicTaskScheduler0. cpp | è§¦å‘äº‹ä»¶ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ |

