# Live555æºç å­¦ä¹ ç¬”è®°5â€”â€”HandlerSet Socketå¤„ç†å™¨é›†åˆ

## ä¸€ã€æ¨¡å—æ¦‚è¿°

### 1.1 HandlerSetçš„ä½œç”¨

HandlerSetç”¨äºç®¡ç†æ‰€æœ‰éœ€è¦ç›‘å¬çš„SocketåŠå…¶å¯¹åº”çš„å›è°ƒå‡½æ•°ã€‚å½“select()æ£€æµ‹åˆ°æŸä¸ªSocketå°±ç»ªæ—¶ï¼Œé€šè¿‡HandlerSetæ‰¾åˆ°å¯¹åº”çš„å¤„ç†å‡½æ•°å¹¶è°ƒç”¨ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HandlerSet åœ¨ç³»ç»Ÿä¸­çš„ä½ç½®                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ç”¨æˆ·ä»£ç                                                        â”‚
â”‚      â”‚                                                          â”‚
â”‚      â”‚ setBackgroundHandling(sockfd, SOCKET_READABLE,           â”‚
â”‚      â”‚                       onDataReceived, this);             â”‚
â”‚      â–¼                                                          â”‚
â”‚   BasicTaskScheduler                                            â”‚
â”‚      â”‚                                                          â”‚
â”‚      â”‚ 1. æ›´æ–° fd_set (fReadSetç­‰)                              â”‚
â”‚      â”‚ 2. æ³¨å†Œåˆ° HandlerSet                                     â”‚
â”‚      â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                     HandlerSet                          â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚   [Socket 3] â†â†’ [Socket 5] â†â†’ [Socket 8] â†â†’ ...          â”‚   â”‚
â”‚   â”‚   handler       handler       handler                   â”‚   â”‚
â”‚   â”‚   data          data          data                      â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚   å­˜å‚¨ Socket â†’ Handler çš„æ˜ å°„                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚      â”‚                                                          â”‚
â”‚      â”‚ select()è¿”å›åï¼Œéå†æ‰¾åˆ°å°±ç»ªçš„Socket                     â”‚
â”‚      â–¼                                                          â”‚
â”‚   (*handler->handlerProc)(handler->clientData, mask);           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ–‡ä»¶ç»“æ„

```
BasicUsageEnvironment/
â”œâ”€â”€ include/
â”‚   â””â”€â”€ HandlerSet.hh           # å¤´æ–‡ä»¶
â””â”€â”€ BasicTaskScheduler0.cpp     # å®ç°ï¼ˆåœ¨æ­¤æ–‡ä»¶ä¸­ï¼‰
```

---

## äºŒã€HandlerDescriptorç±»ï¼ˆå¤„ç†å™¨æè¿°ç¬¦ï¼‰

### 2. 1 ç±»å®šä¹‰

```cpp
// æ–‡ä»¶ï¼šHandlerSet.hh

class HandlerDescriptor {
    // æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œåªæœ‰HandlerSetå¯ä»¥åˆ›å»º
    HandlerDescriptor(HandlerDescriptor* nextHandler);
    virtual ~HandlerDescriptor();

public:
    int socketNum;      // Socket æ–‡ä»¶æè¿°ç¬¦
    int conditionSet;   // ç›‘å¬æ¡ä»¶ï¼ˆSOCKET_READABLE | SOCKET_WRITABLE | ... ï¼‰
    
    // å›è°ƒå‡½æ•°æŒ‡é’ˆ
    TaskScheduler::BackgroundHandlerProc* handlerProc;
    
    // ä¼ é€’ç»™å›è°ƒçš„ç”¨æˆ·æ•°æ®
    void* clientData;

private:
    // åŒå‘é“¾è¡¨æŒ‡é’ˆ
    friend class HandlerSet;
    friend class HandlerIterator;
    HandlerDescriptor* fNextHandler;
    HandlerDescriptor* fPrevHandler;
};
```

### 2.2 æ„é€ å‡½æ•°å’Œææ„å‡½æ•°

```cpp
// æ–‡ä»¶ï¼šBasicTaskScheduler0.cpp

HandlerDescriptor::HandlerDescriptor(HandlerDescriptor* nextHandler)
    : conditionSet(0), handlerProc(NULL) {
    
    // å°†èŠ‚ç‚¹æ’å…¥åˆ°åŒå‘é“¾è¡¨
    if (nextHandler == this) {
        // åˆå§‹åŒ–ï¼šè‡ªå·±æŒ‡å‘è‡ªå·±ï¼ˆç©ºé“¾è¡¨æˆ–ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼‰
        fNextHandler = fPrevHandler = this;
    } else {
        // æ’å…¥åˆ° nextHandler ä¹‹å‰
        fNextHandler = nextHandler;
        fPrevHandler = nextHandler->fPrevHandler;
        nextHandler->fPrevHandler = this;
        fPrevHandler->fNextHandler = this;
    }
}

HandlerDescriptor::~HandlerDescriptor() {
    // ä»åŒå‘é“¾è¡¨ä¸­ç§»é™¤è‡ªå·±
    fNextHandler->fPrevHandler = fPrevHandler;
    fPrevHandler->fNextHandler = fNextHandler;
}
```

### 2.3 æ•°æ®ç»“æ„è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   HandlerDescriptor ç»“æ„                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚               HandlerDescriptor                         â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚   socketNum = 5           Socketç¼–å·                    â”‚   â”‚
â”‚   â”‚   conditionSet = 0x02     SOCKET_READABLE               â”‚   â”‚
â”‚   â”‚   handlerProc = 0x...      å›è°ƒå‡½æ•°æŒ‡é’ˆ                  â”‚   â”‚
â”‚   â”‚   clientData = 0x...      ç”¨æˆ·æ•°æ®æŒ‡é’ˆ                  â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚   fNextHandler â”€â”€â”€â”€â”€â”€â–º    æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹                â”‚   â”‚
â”‚   â”‚   fPrevHandler â—„â”€â”€â”€â”€â”€â”€    æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹                â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚   conditionSet å¯ä»¥æ˜¯ä»¥ä¸‹å€¼çš„ç»„åˆï¼š                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ SOCKET_READABLE   = (1<<1) = 0x02  ç›‘å¬å¯è¯»äº‹ä»¶         â”‚   â”‚
â”‚   â”‚ SOCKET_WRITABLE   = (1<<2) = 0x04  ç›‘å¬å¯å†™äº‹ä»¶         â”‚   â”‚
â”‚   â”‚ SOCKET_EXCEPTION  = (1<<3) = 0x08  ç›‘å¬å¼‚å¸¸äº‹ä»¶         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€HandlerSetç±»ï¼ˆå¤„ç†å™¨é›†åˆï¼‰

### 3.1 ç±»å®šä¹‰

```cpp
// æ–‡ä»¶ï¼šHandlerSet. hh

class HandlerSet {
public:
    HandlerSet();
    virtual ~HandlerSet();

    // æ³¨å†Œ/æ›´æ–°å¤„ç†å™¨
    void assignHandler(int socketNum, int conditionSet,
                       TaskScheduler::BackgroundHandlerProc* handlerProc,
                       void* clientData);
    
    // æ¸…é™¤å¤„ç†å™¨
    void clearHandler(int socketNum);
    
    // ç§»åŠ¨å¤„ç†å™¨ï¼ˆSocketç¼–å·å˜æ›´æ—¶ï¼‰
    void moveHandler(int oldSocketNum, int newSocketNum);

private:
    // æ ¹æ®Socketç¼–å·æŸ¥æ‰¾å¤„ç†å™¨
    HandlerDescriptor* lookupHandler(int socketNum);

private:
    friend class HandlerIterator;
    
    // fHandlers æ˜¯å“¨å…µèŠ‚ç‚¹ï¼Œå®ƒçš„ fNextHandler æŒ‡å‘ç¬¬ä¸€ä¸ªçœŸæ­£çš„å¤„ç†å™¨
    HandlerDescriptor fHandlers;
};
```

### 3.2 æ„é€ å‡½æ•°å’Œææ„å‡½æ•°

```cpp
// æ–‡ä»¶ï¼šBasicTaskScheduler0.cpp

HandlerSet::HandlerSet()
    : fHandlers(&fHandlers) {  // å“¨å…µèŠ‚ç‚¹æŒ‡å‘è‡ªå·±ï¼ˆç©ºé“¾è¡¨ï¼‰
    fHandlers.socketNum = -1;  // å“¨å…µçš„socketNumæ— æ„ä¹‰
}

HandlerSet::~HandlerSet() {
    // åˆ é™¤æ‰€æœ‰å¤„ç†å™¨
    while (fHandlers.fNextHandler != &fHandlers) {
        delete fHandlers.fNextHandler;  // åˆ é™¤ä¼šè‡ªåŠ¨ä»é“¾è¡¨ç§»é™¤
    }
}
```

### 3.3 é“¾è¡¨ç»“æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HandlerSet é“¾è¡¨ç»“æ„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ç©ºé“¾è¡¨ï¼š                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚   â”‚                  â”‚                                          â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                          â”‚
â”‚   â””â”€â–ºâ”‚  fHandlers  â”‚â—„â”˜                                          â”‚
â”‚      â”‚   (å“¨å…µ)    â”‚                                            â”‚
â”‚      â”‚ socket = -1 â”‚                                            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚                                                                 â”‚
â”‚   æœ‰3ä¸ªå¤„ç†å™¨çš„é“¾è¡¨ï¼š                                            â”‚
â”‚                                                                 â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚      â”‚                                                      â”‚   â”‚
â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚      â””â”€â–ºâ”‚fHandlersâ”‚â—„â”€â”€â–ºâ”‚Socket 3 â”‚â—„â”€â”€â–ºâ”‚Socket 5 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚ (å“¨å…µ)  â”‚    â”‚ handler â”‚    â”‚ handler â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                 â”‚
â”‚   â€¢ åŒå‘å¾ªç¯é“¾è¡¨                                                â”‚
â”‚   â€¢ fHandlers æ˜¯å“¨å…µèŠ‚ç‚¹ï¼Œæ°¸è¿œå­˜åœ¨                              â”‚
â”‚   â€¢ çœŸæ­£çš„å¤„ç†å™¨åœ¨ fHandlers ä¹‹å                               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 æ³¨å†Œå¤„ç†å™¨ï¼šassignHandler()

```cpp
// æ–‡ä»¶ï¼šBasicTaskScheduler0.cpp

void HandlerSet::assignHandler(int socketNum, int conditionSet,
                               TaskScheduler::BackgroundHandlerProc* handlerProc,
                               void* clientData) {
    // é¦–å…ˆæŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨è¿™ä¸ªSocketçš„å¤„ç†å™¨
    HandlerDescriptor* handler = lookupHandler(socketNum);
    
    if (handler == NULL) {
        // ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„å¤„ç†å™¨
        // æ’å…¥åˆ° fHandlers ä¹‹åï¼ˆé“¾è¡¨å¤´éƒ¨ï¼‰
        handler = new HandlerDescriptor(fHandlers.fNextHandler);
        handler->socketNum = socketNum;
    }

    // æ›´æ–°å¤„ç†å™¨ä¿¡æ¯
    handler->conditionSet = conditionSet;
    handler->handlerProc = handlerProc;
    handler->clientData = clientData;
}
```

**æ’å…¥è¿‡ç¨‹ç¤ºæ„å›¾ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   assignHandler() æ’å…¥è¿‡ç¨‹                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   åŸé“¾è¡¨ï¼š                                                       â”‚
â”‚   [å“¨å…µ] â—„â”€â”€â–º [Socket 3] â—„â”€â”€â–º [Socket 5] â—„â”€â”€â–º [å“¨å…µ]            â”‚
â”‚                                                                 â”‚
â”‚   æ’å…¥ Socket 8ï¼š                                               â”‚
â”‚                                                                 â”‚
â”‚   æ­¥éª¤1: lookupHandler(8) è¿”å› NULLï¼ˆä¸å­˜åœ¨ï¼‰                   â”‚
â”‚                                                                 â”‚
â”‚   æ­¥éª¤2: new HandlerDescriptor(fHandlers.fNextHandler)          â”‚
â”‚          å³æ’å…¥åˆ°å“¨å…µä¹‹åã€Socket 3 ä¹‹å‰                        â”‚
â”‚                                                                 â”‚
â”‚   ç»“æœï¼š                                                        â”‚
â”‚   [å“¨å…µ] â—„â”€â”€â–º [Socket 8] â—„â”€â”€â–º [Socket 3] â—„â”€â”€â–º [Socket 5]       â”‚
â”‚                                                                 â”‚
â”‚   ğŸ’¡ æ–°èŠ‚ç‚¹æ€»æ˜¯æ’å…¥åˆ°é“¾è¡¨å¤´éƒ¨ï¼ˆå“¨å…µä¹‹åï¼‰                        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.5 æ¸…é™¤å¤„ç†å™¨ï¼šclearHandler()

```cpp
void HandlerSet::clearHandler(int socketNum) {
    HandlerDescriptor* handler = lookupHandler(socketNum);
    delete handler;  // ææ„å‡½æ•°ä¼šè‡ªåŠ¨ä»é“¾è¡¨ç§»é™¤
}
```

### 3.6 ç§»åŠ¨å¤„ç†å™¨ï¼šmoveHandler()

```cpp
void HandlerSet::moveHandler(int oldSocketNum, int newSocketNum) {
    HandlerDescriptor* handler = lookupHandler(oldSocketNum);
    if (handler != NULL) {
        handler->socketNum = newSocketNum;  // åªéœ€æ›´æ–°socketNum
    }
}
```

**ä½¿ç”¨åœºæ™¯ï¼š** å½“ Socket è¢«`dup()`æˆ–`dup2()`å¤åˆ¶åï¼Œæ–‡ä»¶æè¿°ç¬¦ç¼–å·å¯èƒ½æ”¹å˜ï¼Œéœ€è¦æ›´æ–°HandlerSetä¸­çš„è®°å½•ã€‚

### 3.7 æŸ¥æ‰¾å¤„ç†å™¨ï¼šlookupHandler()

```cpp
HandlerDescriptor* HandlerSet::lookupHandler(int socketNum) {
    HandlerDescriptor* handler;
    HandlerIterator iter(*this);
    
    // éå†é“¾è¡¨æŸ¥æ‰¾
    while ((handler = iter. next()) != NULL) {
        if (handler->socketNum == socketNum) break;
    }
    
    return handler;
}
```

---

## å››ã€HandlerIteratorç±»ï¼ˆè¿­ä»£å™¨ï¼‰

### 4.1 ç±»å®šä¹‰

```cpp
// æ–‡ä»¶ï¼šHandlerSet.hh

class HandlerIterator {
public:
    HandlerIterator(HandlerSet& handlerSet);
    virtual ~HandlerIterator();

    HandlerDescriptor* next();  // è¿”å›ä¸‹ä¸€ä¸ªï¼Œåˆ°æœ«å°¾è¿”å›NULL
    void reset();               // é‡ç½®åˆ°å¼€å¤´

private:
    HandlerSet& fOurSet;        // å…³è”çš„HandlerSet
    HandlerDescriptor* fNextPtr; // å½“å‰ä½ç½®
};
```

### 4.2 å®ç°

```cpp
// æ–‡ä»¶ï¼šBasicTaskScheduler0.cpp

HandlerIterator::HandlerIterator(HandlerSet& handlerSet)
    : fOurSet(handlerSet) {
    reset();
}

HandlerIterator::~HandlerIterator() {
}

void HandlerIterator::reset() {
    // æŒ‡å‘ç¬¬ä¸€ä¸ªçœŸæ­£çš„å¤„ç†å™¨ï¼ˆè·³è¿‡å“¨å…µï¼‰
    fNextPtr = fOurSet.fHandlers.fNextHandler;
}

HandlerDescriptor* HandlerIterator::next() {
    HandlerDescriptor* result = fNextPtr;
    
    // å¦‚æœåˆ°è¾¾å“¨å…µèŠ‚ç‚¹ï¼Œè¯´æ˜éå†ç»“æŸ
    if (result == &fOurSet.fHandlers) {
        result = NULL;
    } else {
        // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª
        fNextPtr = fNextPtr->fNextHandler;
    }

    return result;
}
```

### 4.3 è¿­ä»£å™¨å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   HandlerIterator å·¥ä½œåŸç†                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   é“¾è¡¨ï¼š[å“¨å…µ] â—„â”€â”€â–º [A] â—„â”€â”€â–º [B] â—„â”€â”€â–º [C] â—„â”€â”€â–º [å“¨å…µ]           â”‚
â”‚                                                                 â”‚
â”‚   HandlerIterator iter(handlerSet);                             â”‚
â”‚                                                                 â”‚
â”‚   åˆå§‹çŠ¶æ€ï¼ˆresetåï¼‰ï¼š                                          â”‚
â”‚   fNextPtr â”€â”€â”€â”€â”€â”€â–º [A]                                          â”‚
â”‚                                                                 â”‚
â”‚   ç¬¬1æ¬¡ next()ï¼š                                                â”‚
â”‚   è¿”å› [A]ï¼ŒfNextPtr â”€â”€â”€â”€â”€â”€â–º [B]                                â”‚
â”‚                                                                 â”‚
â”‚   ç¬¬2æ¬¡ next()ï¼š                                                â”‚
â”‚   è¿”å› [B]ï¼ŒfNextPtr â”€â”€â”€â”€â”€â”€â–º [C]                                â”‚
â”‚                                                                 â”‚
â”‚   ç¬¬3æ¬¡ next()ï¼š                                                â”‚
â”‚   è¿”å› [C]ï¼ŒfNextPtr â”€â”€â”€â”€â”€â”€â–º [å“¨å…µ]                             â”‚
â”‚                                                                 â”‚
â”‚   ç¬¬4æ¬¡ next()ï¼š                                                â”‚
â”‚   fNextPtr == &fHandlersï¼ˆå“¨å…µï¼‰ï¼Œè¿”å› NULL                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€ä¸BasicTaskSchedulerçš„é…åˆ

### 5.1 setBackgroundHandling()å®Œæ•´æµç¨‹

```cpp
// æ–‡ä»¶ï¼šBasicTaskScheduler. cpp

void BasicTaskScheduler::setBackgroundHandling(int socketNum, 
                                               int conditionSet,
                                               BackgroundHandlerProc* handlerProc, 
                                               void* clientData) {
    if (socketNum < 0) return;
    
#if ! defined(__WIN32__) && !defined(_WIN32) && defined(FD_SETSIZE)
    if (socketNum >= (int)(FD_SETSIZE)) return;  // è¶…å‡ºé™åˆ¶
#endif

    // æ­¥éª¤1ï¼šä»æ‰€æœ‰fd_setä¸­æ¸…é™¤è¿™ä¸ªSocket
    FD_CLR((unsigned)socketNum, &fReadSet);
    FD_CLR((unsigned)socketNum, &fWriteSet);
    FD_CLR((unsigned)socketNum, &fExceptionSet);
    
    if (conditionSet == 0) {
        // æ­¥éª¤2aï¼šå–æ¶ˆç›‘å¬
        fHandlers->clearHandler(socketNum);
        
        // æ›´æ–°æœ€å¤§Socketç¼–å·
        if (socketNum+1 == fMaxNumSockets) {
            --fMaxNumSockets;
        }
    } else {
        // æ­¥éª¤2bï¼šæ³¨å†Œ/æ›´æ–°ç›‘å¬
        fHandlers->assignHandler(socketNum, conditionSet, handlerProc, clientData);
        
        // æ›´æ–°æœ€å¤§Socketç¼–å·
        if (socketNum+1 > fMaxNumSockets) {
            fMaxNumSockets = socketNum+1;
        }
        
        // æ­¥éª¤3ï¼šæ ¹æ®æ¡ä»¶è®¾ç½®fd_set
        if (conditionSet & SOCKET_READABLE)
            FD_SET((unsigned)socketNum, &fReadSet);
        if (conditionSet & SOCKET_WRITABLE)
            FD_SET((unsigned)socketNum, &fWriteSet);
        if (conditionSet & SOCKET_EXCEPTION)
            FD_SET((unsigned)socketNum, &fExceptionSet);
    }
}
```

### 5.2 fd_setä¸HandlerSetçš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                fd_set ä¸ HandlerSet çš„å…³ç³»                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   fd_set (ä½å›¾)                    HandlerSet (é“¾è¡¨)            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ fReadSet:           â”‚         â”‚ Socket 3:           â”‚       â”‚
â”‚   â”‚   bit 3 = 1         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   conditionSet=0x02 â”‚       â”‚
â”‚   â”‚   bit 5 = 1         â”‚         â”‚   handlerProc=...    â”‚       â”‚
â”‚   â”‚                     â”‚         â”‚                     â”‚       â”‚
â”‚   â”‚ fWriteSet:          â”‚         â”‚ Socket 5:           â”‚       â”‚
â”‚   â”‚   bit 5 = 1         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   conditionSet=0x06 â”‚       â”‚
â”‚   â”‚                     â”‚         â”‚   handlerProc=...   â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                 â”‚
â”‚   ä¸¤è€…çš„åˆ†å·¥ï¼š                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚   fd_setï¼š                                              â”‚   â”‚
â”‚   â”‚   â€¢ ä¼ é€’ç»™ select() ç³»ç»Ÿè°ƒç”¨                            â”‚   â”‚
â”‚   â”‚   â€¢ ä½å›¾ç»“æ„ï¼Œé«˜æ•ˆåˆ¤æ–­æŸä¸ªfdæ˜¯å¦åœ¨é›†åˆä¸­                â”‚   â”‚
â”‚   â”‚   â€¢ ä¸å­˜å‚¨å›è°ƒå‡½æ•°ç­‰è¯¦ç»†ä¿¡æ¯                            â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚   HandlerSetï¼š                                          â”‚   â”‚
â”‚   â”‚   â€¢ å­˜å‚¨æ¯ä¸ªSocketçš„è¯¦ç»†ä¿¡æ¯                            â”‚   â”‚
â”‚   â”‚   â€¢ åŒ…æ‹¬å›è°ƒå‡½æ•°ã€ç”¨æˆ·æ•°æ®ã€ç›‘å¬æ¡ä»¶                    â”‚   â”‚
â”‚   â”‚   â€¢ select()è¿”å›åï¼Œç”¨äºæ‰¾åˆ°å¯¹åº”çš„å¤„ç†å™¨                â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚   âš ï¸ ä¸¤è€…å¿…é¡»ä¿æŒåŒæ­¥ï¼                                         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 SingleStep()ä¸­å¤„ç†Socketäº‹ä»¶

```cpp
// æ–‡ä»¶ï¼šBasicTaskScheduler.cppï¼ˆSingleStepå‡½æ•°ç‰‡æ®µï¼‰

// select() è¿”å›åï¼Œéå† HandlerSet æ‰¾åˆ°å°±ç»ªçš„ Socket
HandlerIterator iter(*fHandlers);
HandlerDescriptor* handler;

// ä»ä¸Šæ¬¡å¤„ç†çš„ä½ç½®ä¹‹åå¼€å§‹ï¼ˆä¿è¯å…¬å¹³ï¼‰
if (fLastHandledSocketNum >= 0) {
    while ((handler = iter.next()) != NULL) {
        if (handler->socketNum == fLastHandledSocketNum) break;
    }
    if (handler == NULL) {
        fLastHandledSocketNum = -1;
        iter.reset();
    }
}

// æ‰¾åˆ°ä¸€ä¸ªå°±ç»ªçš„Socketå¹¶å¤„ç†
while ((handler = iter. next()) != NULL) {
    int sock = handler->socketNum;
    int resultConditionSet = 0;
    
    // æ£€æŸ¥è¿™ä¸ªSocketæ˜¯å¦å°±ç»ª
    if (FD_ISSET(sock, &readSet) && FD_ISSET(sock, &fReadSet))
        resultConditionSet |= SOCKET_READABLE;
    if (FD_ISSET(sock, &writeSet) && FD_ISSET(sock, &fWriteSet))
        resultConditionSet |= SOCKET_WRITABLE;
    if (FD_ISSET(sock, &exceptionSet) && FD_ISSET(sock, &fExceptionSet))
        resultConditionSet |= SOCKET_EXCEPTION;
    
    // å¦‚æœæ»¡è¶³ç›‘å¬æ¡ä»¶
    if ((resultConditionSet & handler->conditionSet) != 0 
        && handler->handlerProc != NULL) {
        
        fLastHandledSocketNum = sock;
        
        // è°ƒç”¨å›è°ƒå‡½æ•°ï¼
        (*handler->handlerProc)(handler->clientData, resultConditionSet);
        
        break;  // æ¯æ¬¡åªå¤„ç†ä¸€ä¸ª
    }
}
```

### 5.4 å®Œæ•´çš„äº‹ä»¶å¤„ç†æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Socket äº‹ä»¶å¤„ç†å®Œæ•´æµç¨‹                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   1. ç”¨æˆ·æ³¨å†Œå›è°ƒ                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ setBackgroundHandling(sock, SOCKET_READABLE, cb, data)  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚   2. æ›´æ–°æ•°æ®ç»“æ„                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ â€¢ FD_SET(sock, &fReadSet)    æ›´æ–°fd_set                 â”‚   â”‚
â”‚   â”‚ â€¢ fHandlers->assignHandler() æ›´æ–°HandlerSet             â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚   3. äº‹ä»¶å¾ªç¯ä¸­                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ select(fMaxNumSockets, &readSet, ...)                   â”‚   â”‚
â”‚   â”‚ â€¢ é˜»å¡ç­‰å¾…                                              â”‚   â”‚
â”‚   â”‚ â€¢ è¿”å›æ—¶ readSet ä¸­æ ‡è®°äº†å°±ç»ªçš„Socket                   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚   4. æŸ¥æ‰¾å¤„ç†å™¨                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ HandlerIterator iter(*fHandlers);                       â”‚   â”‚
â”‚   â”‚ while (handler = iter.next()) {                         â”‚   â”‚
â”‚   â”‚     if (FD_ISSET(handler->socketNum, &readSet)) {       â”‚   â”‚
â”‚   â”‚         // æ‰¾åˆ°äº†ï¼                                     â”‚   â”‚
â”‚   â”‚         break;                                          â”‚   â”‚
â”‚   â”‚     }                                                   â”‚   â”‚
â”‚   â”‚ }                                                       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚   5. è°ƒç”¨å›è°ƒ                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ (*handler->handlerProc)(handler->clientData, mask);     â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚ å³ï¼šcb(data, SOCKET_READABLE)                           â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€ä½¿ç”¨ç¤ºä¾‹

### 6.1 ç›‘å¬Socketå¯è¯»äº‹ä»¶

```cpp
class TcpConnection {
public:
    TcpConnection(UsageEnvironment& env, int sockfd)
        : fEnv(env), fSocket(sockfd) {
        
        // æ³¨å†Œå¯è¯»äº‹ä»¶ç›‘å¬
        fEnv.taskScheduler().setBackgroundHandling(
            fSocket,
            SOCKET_READABLE,
            incomingDataHandler,
            this
        );
    }
    
    ~TcpConnection() {
        // å–æ¶ˆç›‘å¬
        fEnv.taskScheduler().disableBackgroundHandling(fSocket);
        close(fSocket);
    }
    
private:
    static void incomingDataHandler(void* clientData, int mask) {
        TcpConnection* conn = (TcpConnection*)clientData;
        conn->handleIncomingData();
    }
    
    void handleIncomingData() {
        char buffer[1024];
        int bytesRead = recv(fSocket, buffer, sizeof(buffer), 0);
        
        if (bytesRead > 0) {
            // å¤„ç†æ”¶åˆ°çš„æ•°æ®
            processData(buffer, bytesRead);
        } else if (bytesRead == 0) {
            // è¿æ¥å…³é—­
            delete this;
        } else {
            // é”™è¯¯å¤„ç†
            fEnv << "recv() failed\n";
        }
    }
    
    void processData(char* data, int len) {
        // å¤„ç†æ•°æ®... 
    }
    
    UsageEnvironment& fEnv;
    int fSocket;
};
```

### 6.2 ç›‘å¬å¤šä¸ªæ¡ä»¶

```cpp
// åŒæ—¶ç›‘å¬å¯è¯»å’Œå¯å†™
env.taskScheduler().setBackgroundHandling(
    sockfd,
    SOCKET_READABLE | SOCKET_WRITABLE,
    socketHandler,
    this
);

// å›è°ƒå‡½æ•°ä¸­åˆ¤æ–­æ˜¯å“ªç§äº‹ä»¶
static void socketHandler(void* clientData, int mask) {
    MyClass* self = (MyClass*)clientData;
    
    if (mask & SOCKET_READABLE) {
        self->handleRead();
    }
    
    if (mask & SOCKET_WRITABLE) {
        self->handleWrite();
    }
    
    if (mask & SOCKET_EXCEPTION) {
        self->handleException();
    }
}
```

### 6.3 åŠ¨æ€ä¿®æ”¹ç›‘å¬æ¡ä»¶

```cpp
class AsyncSender {
public:
    void startSending() {
        // å¼€å§‹å‘é€æ—¶ï¼Œç›‘å¬å¯å†™äº‹ä»¶
        fEnv. taskScheduler().setBackgroundHandling(
            fSocket,
            SOCKET_WRITABLE,
            writeHandler,
            this
        );
    }
    
    void stopSending() {
        // å‘é€å®Œæ¯•ï¼Œåªç›‘å¬å¯è¯»äº‹ä»¶
        fEnv.taskScheduler(). setBackgroundHandling(
            fSocket,
            SOCKET_READABLE,
            readHandler,
            this
        );
    }
    
private:
    static void writeHandler(void* clientData, int mask) {
        AsyncSender* self = (AsyncSender*)clientData;
        
        int bytesSent = send(self->fSocket, self->fBuffer, self->fDataLen, 0);
        
        if (bytesSent >= self->fDataLen) {
            // å‘é€å®Œæ¯•
            self->stopSending();
        } else {
            // è¿˜æœ‰æ•°æ®æœªå‘é€ï¼Œç»§ç»­ç­‰å¾…å¯å†™
            self->fBuffer += bytesSent;
            self->fDataLen -= bytesSent;
        }
    }
    
    UsageEnvironment& fEnv;
    int fSocket;
    char* fBuffer;
    int fDataLen;
};
```

## ä¸ƒã€ä¸ DelayQueue çš„å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                DelayQueue vs HandlerSet                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚              DelayQueue              HandlerSet                 â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   ç”¨é€”    â”‚ ç®¡ç†å®šæ—¶ä»»åŠ¡    â”‚    â”‚ ç®¡ç†Socketå›è°ƒ  â”‚            â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   ç»“æ„    â”‚ åŒå‘é“¾è¡¨        â”‚    â”‚ åŒå‘é“¾è¡¨        â”‚            â”‚
â”‚           â”‚ æŒ‰æ—¶é—´æ’åº      â”‚    â”‚ æ— åº            â”‚            â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   ç‰¹ç‚¹    â”‚ å¢é‡æ—¶é—´å­˜å‚¨    â”‚    â”‚ ç®€å•å­˜å‚¨        â”‚            â”‚
â”‚           â”‚ éœ€è¦æ—¶é—´åŒæ­¥    â”‚    â”‚ æ— éœ€åŒæ­¥        â”‚            â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   ä¸»è¦    â”‚ addEntry()      â”‚    â”‚ assignHandler() â”‚            â”‚
â”‚   æ“ä½œ    â”‚ handleAlarm()   â”‚    â”‚ clearHandler()  â”‚            â”‚
â”‚           â”‚ synchronize()   â”‚    â”‚ lookupHandler() â”‚            â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â”‚   ç›¸åŒç‚¹ï¼š                                                       â”‚
â”‚   â€¢ éƒ½ä½¿ç”¨åŒå‘å¾ªç¯é“¾è¡¨                                          â”‚
â”‚   â€¢ éƒ½æœ‰å“¨å…µèŠ‚ç‚¹ç®€åŒ–è¾¹ç•Œå¤„ç†                                    â”‚
â”‚   â€¢ éƒ½æ”¯æŒè¿­ä»£å™¨éå†                                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…«ã€å°ç»“

### 8.1 æœ¬è¯¾è¦ç‚¹

1. **HandlerDescriptor** å­˜å‚¨å•ä¸ª Socket çš„å¤„ç†ä¿¡æ¯ï¼ˆSocketå·ã€ç›‘å¬æ¡ä»¶ã€å›è°ƒå‡½æ•°ã€ç”¨æˆ·æ•°æ®ï¼‰
2.  **HandlerSet** ä½¿ç”¨åŒå‘å¾ªç¯é“¾è¡¨ç®¡ç†æ‰€æœ‰ HandlerDescriptor
3. **HandlerIterator** æä¾›éå† HandlerSet çš„è¿­ä»£å™¨
4. **fd_set ä¸ HandlerSet** å¿…é¡»ä¿æŒåŒæ­¥
5. **SingleStep()** ä¸­éå† HandlerSet æ‰¾åˆ°å°±ç»ªçš„ Socket å¹¶è°ƒç”¨å…¶å›è°ƒ

### 8.2 æ ¸å¿ƒå‡½æ•°é€ŸæŸ¥è¡¨

| å‡½æ•°              | æ‰€å±ç±»          | åŠŸèƒ½                    |
| ----------------- | --------------- | ----------------------- |
| `assignHandler()` | HandlerSet      | æ³¨å†Œ/æ›´æ–° Socket å¤„ç†å™¨ |
| `clearHandler()`  | HandlerSet      | ç§»é™¤ Socket å¤„ç†å™¨      |
| `moveHandler()`   | HandlerSet      | æ›´æ–° Socket ç¼–å·        |
| `lookupHandler()` | HandlerSet      | æŸ¥æ‰¾ Socket å¤„ç†å™¨      |
| `next()`          | HandlerIterator | è·å–ä¸‹ä¸€ä¸ªå¤„ç†å™¨        |
| `reset()`         | HandlerIterator | é‡ç½®è¿­ä»£å™¨              |

### 8.3 ç±»å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç±»å…³ç³»å›¾                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   BasicTaskScheduler                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ - fHandlers: HandlerSet*                                â”‚   â”‚
â”‚   â”‚ - fReadSet, fWriteSet, fExceptionSet: fd_set           â”‚   â”‚
â”‚   â”‚ + setBackgroundHandling()                               â”‚   â”‚
â”‚   â”‚ + SingleStep()                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â”‚ ä½¿ç”¨                             â”‚
â”‚                              â–¼                                  â”‚
â”‚   HandlerSet                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ - fHandlers: HandlerDescriptor (å“¨å…µ)                   â”‚   â”‚
â”‚   â”‚ + assignHandler()                                       â”‚   â”‚
â”‚   â”‚ + clearHandler()                                        â”‚   â”‚
â”‚   â”‚ + lookupHandler()                                       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â”‚ åŒ…å«å¤šä¸ª                         â”‚
â”‚                              â–¼                                  â”‚
â”‚   HandlerDescriptor                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ + socketNum: int                                        â”‚   â”‚
â”‚   â”‚ + conditionSet: int                                     â”‚   â”‚
â”‚   â”‚ + handlerProc: BackgroundHandlerProc*                   â”‚   â”‚
â”‚   â”‚ + clientData: void*                                     â”‚   â”‚
â”‚   â”‚ - fNextHandler, fPrevHandler                            â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚   HandlerIterator                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ - fOurSet: HandlerSet&                                  â”‚   â”‚
â”‚   â”‚ - fNextPtr: HandlerDescriptor*                          â”‚   â”‚
â”‚   â”‚ + next(): HandlerDescriptor*                            â”‚   â”‚
â”‚   â”‚ + reset()                                               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

