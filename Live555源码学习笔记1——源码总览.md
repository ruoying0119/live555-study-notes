# Live555源码学习笔记1——总览与架构

## 一、Live555是什么？

### 1.1 简介

**Live555**是一个用C++编写的开源多媒体流媒体库，它实现了流媒体领域的核心协议栈，是学习流媒体技术的最佳实践项目之一。在网络摄像头、视频监控系统应用广泛，如实现RTSP服务器，推送H.264/H.265视频流；NVR的流媒体转发；同时VLC播放器也使用Live555作为RTSP客户端。

**Live555**官网： [http://www.live555.com](http://www.live555.com/)

### 1.2 实现的协议

```
┌─────────────────────────────────────────────────────────────┐
│                    Live555 协议栈                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   应用层协议：                                               │
│   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐       │
│   │  RTSP   │  │   SDP   │  │  RTCP   │  │   RTP   │       │
│   │ 会话控制 │  │ 媒体描述 │  │ 传输控制 │  │ 媒体传输 │       │
│   └─────────┘  └─────────┘  └─────────┘  └─────────┘       │
│                                                             │
│   媒体封装格式：                                              │
│   H.264 / H.265 / MPEG-4 / JPEG / AAC / MP3 / G.711 等     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 二、源码目录结构

### 2. 1 核心模块一览

```
live/
├── UsageEnvironment/        # 使用环境抽象层（接口定义）
│   ├── include/
│   │   ├── UsageEnvironment.hh    ⭐ 核心抽象类
│   │   ├── HashTable.hh           哈希表接口
│   │   ├── Boolean.hh             布尔类型定义
│   │   └── strDup.hh              字符串工具
│   ├── UsageEnvironment.cpp
│   ├── HashTable.cpp
│   └── strDup.cpp
│
├── BasicUsageEnvironment/   # 使用环境具体实现
│   ├── include/
│   │   ├── BasicUsageEnvironment.hh
│   │   ├── BasicTaskScheduler.hh
│   │   ├── DelayQueue.hh          ⭐ 延时队列
│   │   └── HandlerSet.hh          Socket处理器集合
│   ├── BasicUsageEnvironment.cpp
│   ├── BasicTaskScheduler.cpp     ⭐ 任务调度器核心
│   ├── BasicTaskScheduler0.cpp
│   └── DelayQueue.cpp
│
├── groupsock/               # 网络层封装
│   ├── include/
│   │   ├── Groupsock.hh           组播/单播Socket
│   │   ├── NetInterface.hh        网络接口
│   │   └── NetAddress.hh          网络地址
│   └── *. cpp
│
├── liveMedia/               # 核心媒体处理 ⭐最重要
│   ├── include/
│   │   ├── Medium.hh              所有媒体类的基类
│   │   ├── MediaSource.hh         数据源基类
│   │   ├── MediaSink.hh           数据接收器基类
│   │   ├── RTSPServer.hh          RTSP服务器
│   │   ├── RTSPClient.hh          RTSP客户端
│   │   ├── RTPSink.hh             RTP发送
│   │   ├── RTPSource.hh           RTP接收
│   │   ├── H264VideoRTPSink.hh    H.264 RTP封装
│   │   └── ...                     更多媒体类
│   └── *.cpp
│
├── mediaServer/             # RTSP服务器示例程序
├── proxyServer/             # RTSP代理服务器
├── hlsProxy/                # HLS代理服务器
├── testProgs/               # 测试程序和示例代码 ⭐入门必看
│
└── config.*                 # 各平台编译配置文件
```

### 2.2 模块功能说明

| 模块                      | 功能                                       |
| ------------------------- | ------------------------------------------ |
| **UsageEnvironment**      | 定义抽象接口：任务调度、日志输出、错误处理 |
| **BasicUsageEnvironment** | 上述接口的基础实现，基于select()的事件循环 |
| **groupsock**             | 网络Socket封装，支持单播和组播             |
| **liveMedia**             | 核心媒体处理，RTSP/RTP/编解码器            |
| **testProgs**             | 各种示例程序，学习的最佳起点               |
| **mediaServer**           | 完整的RTSP服务器实现                       |

---

## 三、核心架构图

### 3.1 整体架构

```
┌──────────────────────────────────────────────────────────────────┐
│                         应用层程序                                │
│              (mediaServer / proxyServer / testProgs)             │
│                    你自己写的RTSP服务器/客户端                      │
└─────────────────────────────┬────────────────────────────────────┘
                              │
┌─────────────────────────────▼────────────────────────────────────┐
│                         liveMedia                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐   │
│  │ RTSPServer  │  │ RTSPClient  │  │ MediaSession/Subsession │   │
│  │ RTSP服务器   │  │ RTSP客户端   │  │ 媒体会话管理             │   │
│  └──────┬──────┘  └──────┬──────┘  └────────────┬────────────┘   │
│         │                │                      │                 │
│  ┌──────▼──────┐  ┌──────▼──────┐  ┌───────────▼───────────┐    │
│  │ ServerMedia │  │ MediaSource │  │ RTPSink / RTPSource   │    │
│  │  Session    │  │  (H264/AAC) │  │ (发送/接收RTP数据)     │    │
│  │ 服务端会话   │  │  数据源      │  │                       │    │
│  └─────────────┘  └─────────────┘  └───────────────────────┘    │
└─────────────────────────────┬────────────────────────────────────┘
                              │
┌─────────────────────────────▼────────────────────────────────────┐
│                         groupsock                                 │
│              (Socket封装、组播支持、网络地址管理)                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐   │
│  │  Groupsock  │  │ NetAddress  │  │   NetInterface          │   │
│  │  Socket封装  │  │  地址管理   │  │   网络接口              │   │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘   │
└─────────────────────────────┬────────────────────────────────────┘
                              │
┌─────────────────────────────▼────────────────────────────────────┐
│              UsageEnvironment / BasicUsageEnvironment             │
│             (任务调度 TaskScheduler、日志输出、事件循环)             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐   │
│  │TaskScheduler│  │ DelayQueue  │  │  UsageEnvironment       │   │
│  │  任务调度器  │  │  延时队列   │  │  环境抽象               │   │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘   │
└──────────────────────────────────────────────────────────────────┘
```

### 3.2 模块依赖关系

```
                    ┌─────────────────┐
                    │    应用程序      │
                    └────────┬────────┘
                             │ 依赖
                             ▼
                    ┌─────────────────┐
                    │    liveMedia    │
                    └────────┬────────┘
                             │ 依赖
              ┌──────────────┼──────────────┐
              ▼              ▼              ▼
    ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐
    │  groupsock  │  │UsageEnviron │  │BasicUsageEnvironment│
    └──────┬──────┘  │   ment      │  └──────────┬──────────┘
           │         └──────┬──────┘             │
           │                │ 依赖               │ 实现
           │                ▼                    │
           │         ┌─────────────┐             │
           └────────►│  操作系统    │◄────────────┘
                     │ (Socket/   │
                     │  select)   │
                     └─────────────┘
```

---

## 四、核心设计思想

### 4.1 单线程事件驱动模型

Live555 采用**单线程事件驱动**模型，这是其最重要的设计特点：

```
┌─────────────────────────────────────────────────────────────────┐
│                    单线程事件驱动模型                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                     主线程                               │   │
│   │                                                         │   │
│   │   while(1) {                                            │   │
│   │       // 1. 检查是否有Socket就绪                         │   │
│   │       // 2. 检查是否有定时任务到期                        │   │
│   │       // 3. 检查是否有事件触发                           │   │
│   │       // 4. 处理一个事件                                 │   │
│   │       SingleStep();                                     │   │
│   │   }                                                     │   │
│   │                                                         │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   优点：                                                        │
│   ✓ 无需加锁，没有竞态条件                                       │
│   ✓ 代码简单，容易理解和调试                                      │
│   ✓ 资源占用少，适合嵌入式设备                                    │
│                                                                 │
│   缺点：                                                        │
│   ✗ 无法充分利用多核CPU                                         │
│   ✗ 回调函数必须快速返回，不能阻塞                               │
│                                                                 │
│   💡 重要：所有回调函数都在同一个线程中串行执行！                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 抽象与实现分离

Live555 大量使用了**依赖倒置原则**，将接口定义和具体实现分离：

```
┌─────────────────────────────────────────────────────────────────┐
│                    抽象与实现分离                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   UsageEnvironment (抽象接口)                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  - taskScheduler()      获取任务调度器                   │   │
│   │  - setResultMsg()       设置结果消息                     │   │
│   │  - operator<<()         日志输出                         │   │
│   │  (纯虚函数，定义"做什么")                                │   │
│   └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              │ 继承实现                         │
│                              ▼                                  │
│   BasicUsageEnvironment (具体实现)                              │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  - 实现所有纯虚函数                                      │   │
│   │  - 使用标准输出打印日志                                  │   │
│   │  - 使用select()实现事件循环                              │   │
│   │  (定义"怎么做")                                         │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   好处：可以根据不同平台实现不同的UsageEnvironment              │
│         例如：GUI环境、嵌入式RTOS环境等                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 回调机制

Live555 大量使用回调函数来实现事件驱动：

```cpp
// 回调函数类型定义
typedef void TaskFunc(void* clientData);

// 注册回调的典型模式
scheduler->scheduleDelayedTask(
    1000000,           // 延时（微秒）
    myCallbackFunc,    // 回调函数指针
    myData             // 传递给回调的数据
);

// 回调被调用时
myCallbackFunc(myData);  // 系统自动调用
```

---

## 五、学习路线图

```
┌─────────────────────────────────────────────────────────────────┐
│                    Live555 学习路线图                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  第一阶段：基础环境层                                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 课程1: UsageEnvironment 抽象接口                        │   │
│  │ 课程2: BasicTaskScheduler 任务调度器实现                │   │
│  │ 课程3: DelayQueue 延时队列                              │   │
│  │ 课程4: HandlerSet Socket处理器集合                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  第二阶段：网络层                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 课程5: Groupsock 网络Socket封装                         │   │
│  │ 课程6: NetAddress 网络地址管理                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  第三阶段：媒体层                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 课程7: Medium 基类与媒体对象管理                         │   │
│  │ 课程8: Source/Sink 数据流模型                           │   │
│  │ 课程9: RTP/RTCP 协议实现                                │   │
│  │ 课程10: RTSPServer 服务器实现                           │   │
│  │ 课程11: RTSPClient 客户端实现                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  第四阶段：实战应用                                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 课程12: testProgs 示例程序分析                          │   │
│  │ 课程13: 实现自己的RTSP服务器                            │   │
│  │ 课程14: 实现自己的RTSP客户端                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

